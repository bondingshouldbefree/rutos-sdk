From 3233c90d0239c4c3dd8037d3f6225a50f59a3015 Mon Sep 17 00:00:00 2001
From: Joris Vaisvila <joris.vaisvila@teltonika.lt>
Date: Tue, 27 May 2025 16:27:45 +0300
Subject: [PATCH 1/1] add support to load key from tpm handle

---
 openssl.c | 51 +++++++++++++++++++++++++++++++++++++++++++++++++++
 1 file changed, 51 insertions(+)

diff --git a/openssl.c b/openssl.c
index 12a08692..1b421028 100644
--- a/openssl.c
+++ b/openssl.c
@@ -31,6 +31,8 @@
 #include <openssl/bio.h>
 #include <openssl/ui.h>
 #include <openssl/rsa.h>
+#include <openssl/provider.h>
+#include <openssl/store.h>
 
 #include <sys/types.h>
 
@@ -935,6 +937,52 @@ static int is_pem_password_error(struct openconnect_info *vpninfo, struct cert_i
 	return 0;
 }
 
+static int load_ossl_tpm_handle(struct openconnect_info *vpninfo, struct cert_info *certinfo, 
+		EVP_PKEY **key)
+{
+	OSSL_STORE_CTX *store_ctx = NULL;
+	OSSL_STORE_INFO *store_info = NULL;
+	UI_METHOD *meth = create_openssl_ui();
+	OSSL_PROVIDER_load(NULL, "tpm2");
+	int ret = 0;
+	store_ctx = OSSL_STORE_open_ex(certinfo->key, NULL, NULL, meth, vpninfo->https_ctx, NULL, NULL, NULL);
+	if (meth)
+		UI_destroy_method(meth);
+
+	if (!store_ctx) {
+		ret = -EINVAL;
+		goto end;
+	}
+
+	store_info = OSSL_STORE_load(store_ctx);
+
+	if (!store_info) {
+		ret = -EINVAL;
+		goto end;
+	}
+
+	*key = OSSL_STORE_INFO_get1_PKEY(store_info);
+	if (!*key) {
+		ret = -EINVAL;
+		goto end;
+	}
+
+	if (!SSL_CTX_use_PrivateKey(vpninfo->https_ctx, *key)) {
+		ret = -EINVAL;
+		goto end;
+	}
+end:
+	OSSL_STORE_close(store_ctx);
+	if (ret < 0) {
+		vpn_progress(vpninfo, PRG_ERR,
+			     _("Failed to load OpenSSL store key %s\n"),
+			     certinfo->key);
+		openconnect_report_ssl_errors(vpninfo);
+		return -EINVAL;
+	}
+	return ret;
+}
+
 static int xload_certificate(struct openconnect_info *vpninfo, struct cert_info *certinfo,
 			    struct ossl_cert_info *oci)
 {
@@ -1017,6 +1065,9 @@ static int xload_certificate(struct openconnect_info *vpninfo, struct cert_info
 	if (!strncmp(certinfo->key, "pkcs11:", 7))
 		return load_pkcs11_key(vpninfo, certinfo, &oci->key);
 
+	if (!strncmp(certinfo->key, "handle:", 7))
+		return load_ossl_tpm_handle(vpninfo, certinfo, &oci->key);
+
 	f = openconnect_fopen_utf8(vpninfo, certinfo->key, "rb");
 	if (!f) {
 		vpn_progress(vpninfo, PRG_ERR,
-- 
2.49.0

