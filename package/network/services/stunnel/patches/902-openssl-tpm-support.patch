From de29b13ee684c163807911a7ea57040dc4e32ae8 Mon Sep 17 00:00:00 2001
From: Joris Vaisvila <joris.vaisvila@teltonika.lt>
Date: Wed, 28 May 2025 13:05:34 +0300
Subject: [PATCH 1/1] add tpm2 support

---
 src/common.h |  1 +
 src/ctx.c    | 45 +++++++++++++++++++++++++++++++++++++++++++++
 2 files changed, 46 insertions(+)

diff --git a/src/common.h b/src/common.h
index 2b4869f..e45402f 100644
--- a/src/common.h
+++ b/src/common.h
@@ -514,6 +514,7 @@ STACK_OF(SSL_COMP) *SSL_COMP_get_compression_methods(void);
 #endif /* OPENSSL_VERSION_NUMBER>=0x10101000L */
 #if OPENSSL_VERSION_NUMBER>=0x30000000L
 #include <openssl/provider.h>
+#include <openssl/store.h>
 #include <openssl/proverr.h>
 #endif /* OPENSSL_VERSION_NUMBER>=0x30000000L */
 
diff --git a/src/ctx.c b/src/ctx.c
index 8d0e9de..30760b1 100644
--- a/src/ctx.c
+++ b/src/ctx.c
@@ -904,10 +904,55 @@ NOEXPORT int load_cert_file(SERVICE_OPTIONS *section) {
     return 0; /* OK */
 }
 
+NOEXPORT int load_ossl_tpm_handle(const char *path, SSL_CTX *ctx)
+{
+	OSSL_STORE_CTX *store_ctx = NULL;
+	OSSL_STORE_INFO *store_info = NULL;
+	EVP_PKEY *key = NULL;
+	OSSL_PROVIDER_load(NULL, "tpm2");
+	int ret = 0;
+	store_ctx = OSSL_STORE_open_ex(path, NULL, NULL, NULL, NULL, NULL, NULL, NULL);
+
+	if (!store_ctx) {
+		ret = -EINVAL;
+		goto end;
+	}
+
+	store_info = OSSL_STORE_load(store_ctx);
+
+	if (!store_info) {
+		ret = 1;
+		goto end;
+	}
+
+	key = OSSL_STORE_INFO_get1_PKEY(store_info);
+	if (!key) {
+		ret = 1;
+		goto end;
+	}
+
+	if (!SSL_CTX_use_PrivateKey(ctx, key)) {
+		ret = 1;
+		goto end;
+	}
+end:
+	OSSL_STORE_close(store_ctx);
+	if (ret) {
+		s_log(LOG_ERR, "Unable to load key %s", path);
+		return 1;
+	}
+	return ret;
+}
+
+
 NOEXPORT int load_key_file(SERVICE_OPTIONS *section) {
     int i, success;
 
     s_log(LOG_INFO, "Loading private key from file: %s", section->key);
+
+	if (strncmp(section->key, "handle:", 7) == 0) 
+		return load_ossl_tpm_handle(section->key, section->ctx);
+
     if(file_permissions(section->key))
         return 1; /* FAILED */
 
-- 
2.49.0

